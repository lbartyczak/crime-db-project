<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trends in Crime Data in Chicago</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        h1 {
            text-align: center;
            margin-top: 30px;
            margin-bottom: 130px;
        }

        #submit {
            margin-top: 15px;
        }

        #additionalOptionsLabel {
            margin-top: 15px;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>Trends in Crime Data in Chicago</h1>
        <div class="row">
            <div class="col-md-4">
                <label for="questions" class="form-label">Select a question</label>
                <select class="form-select" id="questions">
                    <option value="" selected>Select a question</option>
                    <option value="1">Question 1</option>
                    <option value="2">Question 2</option>
                    <option value="3">Question 3</option>
                    <option value="4">Question 4</option>
                </select>
                <div id="question4-options" style="display: none;">
                    <label for="additionalOptions" class="form-label" id="additionalOptionsLabel">Crime Type 1</label>
                    <select class="form-select" id="additionalOptions">
                        <option value="type1">Type 1</option>
                        <option value="type2">Type 2</option>
                        <option value="type3">Type 3</option>
                    </select>
                    <label for="additionalOptions2" class="form-label" id="additionalOptionsLabel2">Crime Type 2</label>
                    <select class="form-select" id="additionalOptions2">
                        <option value="type1">Type 1</option>
                        <option value="type2">Type 2</option>
                        <option value="type3">Type 3</option>
                    </select>
                    <label for="additionalOptions3" class="form-label" id="additionalOptionsLabel3">District</label>
                    <select class="form-select" id="additionalOptions3">
                        <option value="district1">District 1</option>
                        <option value="district2">District 2</option>
                        <option value="district3">District 3</option>
                    </select>
                </div>
                <button class="btn btn-primary mt-2" id="submit">Submit</button>
            </div>

            <div class="col-md-8">
                <canvas id="chart"></canvas>
            </div>
        </div>
    </div>
    <script>
        const hostname = 'localhost';
        const port = 8000;
        const ctx = document.getElementById('chart').getContext('2d');
        const chart = new Chart(ctx, {
            type: 'line',
            data: {}
        });

        document.getElementById('questions').addEventListener('change', () => {
            const questionId = document.getElementById('questions').value;
            const question4Options = document.getElementById('question4-options');

            if (questionId === '4') {
                question4Options.style.display = 'block';
            } else {
                question4Options.style.display = 'none';
            }
        });

        document.getElementById('submit').addEventListener('click', async () => {
            chart.data.labels = [];
            chart.data.datasets = [];
            chart.update();

            const questionId = document.getElementById('questions').value;
            const district = document.getElementById('districts').value;
            const type1 = document.getElementById('type1').value;
            const type2 = document.getElementById('type2').value;
            const response = await fetch(`http://${hostname}:${port}/get-data?questionId=${questionId}&district=${district}&type1=${type1}&type2=${type2}`);
            const data = await response.json();

            if (questionId == '3') {
                const processedData = data.reduce((acc, [year, crimeType, amount]) => {
                    if (!acc.labels.includes(year)) {
                        acc.labels.push(year);
                    }

                    if (!acc.dataByCrimeType.hasOwnProperty(crimeType)) {
                        acc.dataByCrimeType[crimeType] = Array(acc.labels.length).fill(null);
                    }

                    const index = acc.labels.indexOf(year);
                    acc.dataByCrimeType[crimeType][index] = amount;

                    return acc;
                }, { labels: [], dataByCrimeType: {} });

                const datasets = Object.entries(processedData.dataByCrimeType).map(([crimeType, dataPoints], index) => {
                    const colors = ['rgba(75, 192, 192, 1)', 'rgba(255, 99, 132, 1)', 'rgba(255, 206, 86, 1)'];
                    return {
                        label: crimeType,
                        data: dataPoints,
                        borderColor: colors[index % colors.length],
                        backgroundColor: colors[index % colors.length],
                        borderWidth: 1,
                        fill: false
                    };
                });

                chart.data.labels = processedData.labels;
                chart.data.datasets = datasets;
                chart.update();
            }
            else if (questionId == '1') {
                const labels = data.map(item => item[0]);
                const dataPoints = data.map(item => item[1]);

                const datasets = [{
                    label: 'Index',
                    data: dataPoints,
                    backgroundColor: 'rgba(75, 192, 192, 0.2)',
                    borderColor: 'rgba(75, 192, 192, 1)',
                    borderWidth: 1
                }];

                chart.data.labels = labels;
                chart.data.datasets = datasets;
                chart.update();
            }
            else if (questionId == '2') {
                const labels = data.map(item => item[0]);
                const dataPoints = data.map(item => item[1]);

                const datasets = [{
                    label: 'Average Days',
                    data: dataPoints,
                    backgroundColor: 'rgba(75, 192, 192, 0.2)',
                    borderColor: 'rgba(75, 192, 192, 1)',
                    borderWidth: 1
                }];

                chart.data.labels = labels;
                chart.data.datasets = datasets;
                chart.update();
            }
            else if (questionId == '4') {
                const labels = data.map(item => item[0]);
                const type1Data = data.map(item => item[1]);
                const type2Data = data.map(item => item[2]);
                const othersData = data.map(item => item[3]);

                const datasets = [
                    {
                        label: type1,
                        data: type1Data,
                        borderColor: 'rgba(75, 192, 192, 1)',
                        backgroundColor: 'rgba(75, 192, 192, 0.2)',
                        borderWidth: 1,
                        fill: false
                    },
                    {
                        label: type2,
                        data: type2Data,
                        borderColor: 'rgba(255, 99, 132, 1)',
                        backgroundColor: 'rgba(255, 99, 132, 0.2)',
                        borderWidth: 1,
                        fill: false
                    },
                    {
                        label: 'Others',
                        data: othersData,
                        borderColor: 'rgba(255, 206, 86, 1)',
                        backgroundColor: 'rgba(255, 206, 86, 0.2)',
                        borderWidth: 1,
                        fill: false
                    }
                ];

                chart.data.labels = labels;
                chart.data.datasets = datasets;
                chart.update();
            }

        });
    </script>
</body>

</html>