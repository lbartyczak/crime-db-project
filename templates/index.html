<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trends in Crime Data in Chicago</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        h1 {
            text-align: center;
            margin-top: 30px;
            margin-bottom: 130px;
        }

        #submit {
            margin-top: 15px;
        }

        #additionalOptionsLabel {
            margin-top: 15px;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>Trends in Crime Data in Chicago</h1>
        <div class="row">
            <div class="col-md-4">
                <label for="questions" class="form-label">Select a question</label>
                <select class="form-select" id="questions">
                    <option value="" selected>Select a question</option>
                    <option value="1">Question 1</option>
                    <option value="2">Question 2</option>
                    <option value="3">Question 3</option>
                    <option value="4">Question 4</option>
                </select>
                <div id="question4-options" style="display: none;">
                    <label for="additionalOptions" class="form-label" id="additionalOptionsLabel">Crime Type</label>
                    <select class="form-select" id="additionalOptions">
                        <!-- Crime Type options will be dynamically populated -->
                    </select>
                    <label for="additionalOptions2" class="form-label" id="additionalOptionsLabel2">District</label>
                    <select class="form-select" id="additionalOptions2">
                        <!-- District options will be dynamically populated -->
                    </select>
                </div>
                <button class="btn btn-primary mt-2" id="submit">Submit</button>
            </div>

            <div class="col-md-8">
                <canvas id="chart"></canvas>
            </div>
        </div>
    </div>
    <script src="checkConnection.js"></script>
    <script>
        const hostname = 'localhost';
        const port = 8000;
        const ctx = document.getElementById('chart').getContext('2d');
        const chart = new Chart(ctx, {
            type: 'line',
            data: {}
        });

        document.getElementById('questions').addEventListener('change', async () => {
            const questionId = document.getElementById('questions').value;
            const additionalOptions = document.getElementById('additionalOptions');
            const additionalOptionsLabel = document.getElementById('additionalOptionsLabel');

            if (questionId === '4') {
                additionalOptions.innerHTML = '';
                const types = await getTypes();
                const districts = await getDistricts();

                const typeOptions = types.map((type) => `<option value="${type}">${type}</option>`);
                const districtOptions = districts.map((district) => `<option value="${district}">${district}</option>`);

                const typeSelect1 = `
          <label for="types1" class="form-label">Crime type 1</label>
          <select class="form-select" id="types1">
            ${typeOptions.join('')}
          </select>
        `;

                const typeSelect2 = `
          <label for="types2" class="form-label">Crime type 2</label>
          <select class="form-select" id="types2">
            ${typeOptions.join('')}
          </select>
        `;

                const districtSelect = `
          <label for="districts" class="form-label">District</label>
          <select class="form-select" id="districts">
            ${districtOptions.join('')}
          </select>
        `;

                additionalOptions.innerHTML = `
          ${typeSelect1}
          ${typeSelect2}
          ${districtSelect}
        `;

                additionalOptions.style.display = 'block';
                additionalOptionsLabel.style.display = 'block';
            } else {
                additionalOptions.style.display = 'none';
                additionalOptionsLabel.style.display = 'none';
            }
        });

        document.getElementById('submit').addEventListener('click', async () => {
            chart.data.labels = [];
            chart.data.datasets = [];
            chart.update();

            const questionId = document.getElementById('questions').value;
            const response = await fetch(`http://${hostname}:${port}/get-data?questionId=${questionId}`);
            const data = await response.json();

            if (questionId == '3') {
                const processedData = data.reduce((acc, [year, crimeType, amount]) => {
                    if (!acc.labels.includes(year)) {
                        acc.labels.push(year);
                    }

                    if (!acc.dataByCrimeType.hasOwnProperty(crimeType)) {
                        acc.dataByCrimeType[crimeType] = Array(acc.labels.length).fill(null);
                    }

                    const index = acc.labels.indexOf(year);
                    acc.dataByCrimeType[crimeType][index] = amount;

                    return acc;
                }, { labels: [], dataByCrimeType: {} });

                const datasets = Object.entries(processedData.dataByCrimeType).map(([crimeType, dataPoints], index) => {
                    const colors = ['rgba(75, 192, 192, 1)', 'rgba(255, 99, 132, 1)', 'rgba(255, 206, 86, 1)'];
                    return {
                        label: crimeType,
                        data: dataPoints,
                        borderColor: colors[index % colors.length],
                        backgroundColor: colors[index % colors.length],
                        borderWidth: 1,
                        fill: false
                    };
                });

                chart.data.labels = processedData.labels;
                chart.data.datasets = datasets;
                chart.update();
            }
            else if (questionId == '1') {
                const labels = data.map(item => item[0]);
                const dataPoints = data.map(item => item[1]);

                const datasets = [{
                    label: 'Index',
                    data: dataPoints,
                    backgroundColor: 'rgba(75, 192, 192, 0.2)',
                    borderColor: 'rgba(75, 192, 192, 1)',
                    borderWidth: 1
                }];

                chart.data.labels = labels;
                chart.data.datasets = datasets;
                chart.update();
            }
            else if (questionId == '2') {
                const labels = data.map(item => item[0]);
                const dataPoints = data.map(item => item[1]);

                const datasets = [{
                    label: 'Average Days',
                    data: dataPoints,
                    backgroundColor: 'rgba(75, 192, 192, 0.2)',
                    borderColor: 'rgba(75, 192, 192, 1)',
                    borderWidth: 1
                }];

                chart.data.labels = labels;
                chart.data.datasets = datasets;
                chart.update();
            }
            else if (questionId == '4') {

            }

        });
    </script>
</body>

</html>